{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container my-4">
  <h1 class="mb-3">Jobs Near Me</h1>
  <div id="map" style="height: 520px; border-radius: 12px;"></div>
  <p class="text-muted mt-2">Showing {{ jobs|length }} job(s) with coordinates.</p>
</div>

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function() {
  const map = L.map('map');
  const featuresUrl = "{% url 'jobs.geo' %}";  // <- THIS must be used

  console.log('Fetching:', featuresUrl);      // debug

  map.setView([39.5, -98.35], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  fetch(featuresUrl, { credentials: 'same-origin' })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(geo => {
      console.log('GEO', geo);
      const points = [];
      (geo.features || []).forEach(f => {
        const [lng, lat] = f.geometry.coordinates;
        const p = f.properties || {};
        const m = L.marker([lat, lng]).addTo(map)
          .bindPopup(`<b>${p.title || ''}</b><br>${p.company || ''}<br>${p.location || ''}<br><a href="${p.detail_url || '#'}">View</a>`);
        points.push(m.getLatLng());
      });
      if (points.length) {
        map.fitBounds(L.latLngBounds(points), { padding: [20, 20] });
      } else {
        console.warn('No features returned from jobs.geo');
      }
    })
    .catch(err => console.error('Map load error:', err));
})();
</script>
{% endblock %}
