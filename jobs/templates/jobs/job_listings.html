{% extends 'base.html' %}
{% block content %}
{% load static %}

<!-- Leaflet CSS and JS for map functionality -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<h1>Job Listings</h1>

<!-- Filter form -->
{% if user.is_authenticated and user.role == 'seeker' %}
<form method="GET" class="mb-4">
    <div class="row g-2">
    <div class="col-md-2">
        <label for="title" class="form-label">Job Title</label>
        <input type="text" name="title" id="title" placeholder="Title" class="form-control" value="{{ template_data.filters.title }}">
    </div>
    <div class="col-md-2">
        <label for="skills" class="form-label">Skills</label>
        <input type="text" name="skills" id="skills" placeholder="Skills (comma separated)" class="form-control" value="{{ template_data.filters.skills }}">
    </div>
    <div class="col-md-2">
        <label for="location" class="form-label">Location</label>
        <input type="text" name="location" id="location" placeholder="Location" class="form-control" value="{{ template_data.filters.location }}">
    </div>

    
    <div class="col-md-1">
        <label for="min_salary" class="form-label">Min Salary</label>
        <input type="number" name="min_salary" id="min_salary" placeholder="Min $" class="form-control" value="{{ template_data.filters.min_salary }}">
    </div>
    <div class="col-md-1">
        <label for="max_salary" class="form-label">Max Salary</label>
        <input type="number" name="max_salary" id="max_salary" placeholder="Max $" class="form-control" value="{{ template_data.filters.max_salary }}">
    </div>
    <div class="col-md-2">
    <label for="remote_or_on_site" class="form-label">Remote / On-site</label>
    <select name="remote_or_on_site" id="remote_or_on_site" class="form-control">
        <option value="">Any</option>
        <option value="on_site" {% if template_data.filters.remote_or_on_site == 'on_site' %}selected{% endif %}>On-site</option>
        <option value="remote" {% if template_data.filters.remote_or_on_site == 'remote' %}selected{% endif %}>Remote</option>
        <option value="hybrid" {% if template_data.filters.remote_or_on_site == 'hybrid' %}selected{% endif %}>Hybrid</option>
    </select>
</div>

<div class="col-md-2">
    <label for="visa_sponsorship" class="form-label">Visa Sponsorship</label>
    <select name="visa_sponsorship" id="visa_sponsorship" class="form-control">
        <option value="">Any</option>
        <option value="yes" {% if template_data.filters.visa_sponsorship == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no" {% if template_data.filters.visa_sponsorship == 'no' %}selected{% endif %}>No</option>
    </select>
</div>
        <div class="col-md-12 mt-2">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{% url 'jobs.index' %}" class="btn btn-secondary">Reset</a>
        </div>
    </div>
</form>
{% endif %}

<!-- Recruiter: create a job -->
{% if user.is_authenticated and user.role == 'recruiter' %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8">
            <div class="card shadow p-3 mb-4 rounded">
                <div class="card-body">
                    <b>Create a Job Posting</b><br /><br />
                    <form method="POST" action="{% url 'jobs.create_job' %}">
                        {% csrf_token %}
                        <!-- Job form fields as before -->
                        <p><label for="title">Job Title:</label>
                        <input type="text" name="title" required class="form-control" id="title"></p>

                        <p><label for="skills">Skills (comma separated):</label>
                        <textarea name="skills" required class="form-control" id="skills"></textarea></p>

                        <p><label for="salary">Salary (optional):</label>
                        <input type="number" name="salary" step="0.01" class="form-control" id="salary"></p>

                        <p><label for="location">Location (optional):</label>
                        <input type="text" name="location" class="form-control" id="location" placeholder="e.g., Atlanta, GA"></p>

                        <p>
                            <label>Pin Office Location on Map:</label>
                            <small class="text-muted d-block mb-2">Click on the map to set the exact office location</small>
                            <div id="job-location-map" style="height: 400px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;"></div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="latitude">Latitude:</label>
                                    <input type="number" name="latitude" step="0.000001" class="form-control" id="latitude" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="longitude">Longitude:</label>
                                    <input type="number" name="longitude" step="0.000001" class="form-control" id="longitude" readonly>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="clear-location">Clear Location</button>
                        </p>


                        <p><label for="remote_or_on_site">Remote / On-site:</label>
                        <select name="remote_or_on_site" class="form-control" id="remote_or_on_site">
                            <option value="on_site">On-site</option>
                            <option value="remote">Remote</option>
                            <option value="hybrid">Hybrid</option>
                        </select></p>

                        <p><label for="visa_sponsorship">Visa Sponsorship:</label>
                        <select name="visa_sponsorship" class="form-control" id="visa_sponsorship">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select></p>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Create Job</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Job listings -->
<div class="job-listings">
    {% if template_data.jobs %}
        {% for job in template_data.jobs %}
            <div class="card mb-2 p-3">
                <div class="row">
                    <div class="col-md-8">
                        <h3>{{ job.title }}</h3>
                        <p><strong>Skills:</strong> {{ job.skills }}</p>
                        <p><strong>Location:</strong> {{ job.location|default:"Not specified" }}</p>
                        <p><strong>Remote/On-site:</strong> {{ job.remote_or_on_site|capfirst }}</p>
                        <p><strong>Visa Sponsorship:</strong> {{ job.visa_sponsorship|capfirst }}</p>
                        <p><strong>Salary:</strong>
                            {% if job.salary %} ${{ job.salary }} {% else %} Not listed {% endif %}
                        </p>
                        <p><strong>Posted by:</strong> {{ job.posted_by.username }}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <!-- Action buttons based on user role -->
                        {% if user.is_authenticated and user.role == 'recruiter' and job.posted_by == user %}
                            <a href="{% url 'jobs.edit_job' job_id=job.id %}" class="btn btn-secondary mb-2">Edit</a>
                            <a href="{% url 'jobs.delete_job' job_id=job.id %}" class="btn btn-danger mb-2">Delete</a>
                        {% elif user.is_authenticated and user.role == 'seeker' %}
                            <div class="d-flex flex-column gap-2">
                                {% if job.id in template_data.user_saved_jobs %}
                                    <a href="{% url 'jobs.toggle_save' job_id=job.id %}" class="btn btn-warning btn-sm">
                                        <i class="fas fa-bookmark"></i> Saved
                                    </a>
                                {% else %}
                                    <a href="{% url 'jobs.toggle_save' job_id=job.id %}" class="btn btn-outline-warning btn-sm">
                                        <i class="far fa-bookmark"></i> Save
                                    </a>
                                {% endif %}
                                {% if job.id in template_data.user_applications %}
                                    <span class="badge bg-success fs-6">Already Applied</span>
                                    <a href="{% url 'jobs.track_status' job_id=job.id %}" class="btn btn-info btn-sm">Track Status</a>
                                {% else %}
                                    <a href="{% url 'jobs.apply' job_id=job.id %}" class="btn btn-primary btn-sm">Apply Now</a>
                                {% endif %}
                            </div>
                        {% elif not user.is_authenticated %}
                            <a href="{% url 'accounts.login' %}" class="btn btn-outline-primary mb-2">Login to Apply</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="text-center mt-5">
            <h3>No job postings available.</h3>
            {% if user.is_authenticated and user.role == 'recruiter' %}
                <p>Create your first job posting using the form above!</p>
            {% else %}
                <p>Check back later for new opportunities.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

{% if user.is_authenticated and user.role == 'recruiter' %}
<script>
// Initialize map for job location pinning
let jobLocationMap, locationMarker;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on a default location (e.g., Atlanta, GA)
    jobLocationMap = L.map('job-location-map').setView([33.7756, -84.3963], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(jobLocationMap);
    
    // Add click handler to pin location
    jobLocationMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Update input fields
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);
        
        // Remove existing marker if any
        if (locationMarker) {
            jobLocationMap.removeLayer(locationMarker);
        }
        
        // Add new marker
        locationMarker = L.marker([lat, lng], {
            draggable: true,
            title: 'Office Location'
        }).addTo(jobLocationMap)
          .bindPopup('Office Location<br>Drag to adjust').openPopup();
        
        // Update coordinates when marker is dragged
        locationMarker.on('dragend', function(e) {
            const pos = locationMarker.getLatLng();
            document.getElementById('latitude').value = pos.lat.toFixed(6);
            document.getElementById('longitude').value = pos.lng.toFixed(6);
        });
    });
    
    // Clear location button
    document.getElementById('clear-location').addEventListener('click', function() {
        if (locationMarker) {
            jobLocationMap.removeLayer(locationMarker);
            locationMarker = null;
        }
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
    });
    
    // Try to get user's location and center map
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            jobLocationMap.setView([lat, lng], 12);
        });
    }
});
</script>
{% endif %}

{% endblock content %}
