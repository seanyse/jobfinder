{% extends "base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<div class="container py-4">
  <h2 class="mb-3">My Profile</h2>
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  
  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>Form errors:</strong>
      {{ form.errors }}
    </div>
  {% endif %}
  
  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}


    

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">Profile Picture</div>
          <div class="card-body text-center">
            {% if form.instance.profile_picture %}
              <img src="{{ form.instance.profile_picture.url }}" class="img-fluid rounded mb-3" style="max-height:180px;" alt="Profile picture" />
            {% endif %}
            {{ form.profile_picture }}
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card h-100">
          <div class="card-header">Basics</div>
          <div class="card-body">
            <div class="mb-3">{{ form.headline.label_tag }} {{ form.headline }}</div>
            <div class="mb-3">{{ form.bio.label_tag }} {{ form.bio }}</div>
            <div class="row">
              <div class="col-md-6 mb-3">{{ form.location.label_tag }} {{ form.location }}</div>
              <div class="col-md-6 mb-3">{{ form.website.label_tag }} {{ form.website }}</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Set Your Location on Map</label>
              <p class="text-muted small">Click on the map to set your location. This helps recruiters see where applicants are located.</p>
              <div id="location-map" style="height: 300px; border-radius: 8px; border: 1px solid #ddd;"></div>
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-location">Clear Location</button>
                <span id="location-status" class="ms-2 text-muted small"></span>
              </div>
              {% if form.instance.latitude != None and form.instance.longitude != None %}
                <!-- Explicitly set values for hidden fields -->
                <input type="hidden" name="latitude" id="id_latitude" value="{{ form.instance.latitude }}">
                <input type="hidden" name="longitude" id="id_longitude" value="{{ form.instance.longitude }}">
              {% else %}
                {{ form.latitude }}
                {{ form.longitude }}
              {% endif %}
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">{{ form.github.label_tag }} {{ form.github }}</div>
              <div class="col-md-6 mb-3">{{ form.linkedin.label_tag }} {{ form.linkedin }}</div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                {{ form.commute_radius.label_tag }} 
                {{ form.commute_radius }}
                <small class="text-muted">{{ form.commute_radius.help_text }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Privacy -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Who can view your profile?</label>
      {{ form.privacy_level }}  <!-- uses RadioSelect from the form -->
      <div class="form-text">
        Public: recruiters can find you. Private: recruiters cannot, and you won’t appear in search.
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const radios = document.querySelectorAll('input[name="privacy_level"]');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
        radios.forEach(radio => {
          radio.addEventListener('change', async e => {
            const newValue = e.target.value;
            console.log("Sending privacy:", newValue);
      
            await fetch("{% url 'accounts.profile_edit' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
                "X-Requested-With": "XMLHttpRequest",  // ✅ key line
              },
              body: new URLSearchParams({ "privacy_level": newValue }),
            })
            .then(r => r.json())
            .then(data => console.log("Server says:", data))
            .catch(err => console.error(err));
          });
        });
      });
      </script>
    

    <div class="row g-4 mt-1">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header">Skills</div>
          <div class="card-body">
            <div class="mb-3">{{ form.skills }}</div>
            <div class="mb-2">{{ form.new_skills.label_tag }} {{ form.new_skills }}</div>
            <small class="text-muted">Separate multiple skills with commas.</small>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Projects</span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-project">Add Project</button>
          </div>
          <div class="card-body">
            <div id="projects-formset">
              {{ project_formset.management_form }}
              {% for f in project_formset %}
                <div class="border rounded p-3 mb-3 project-item">
                  <div class="mb-2"><label for="{{ f.title.id_for_label }}">Title:</label> {{ f.title }}</div>
                  <div class="mb-2"><label for="{{ f.url.id_for_label }}">Url:</label> {{ f.url }}</div>
                  <div class="mb-2"><label for="{{ f.description.id_for_label }}">Description:</label> {{ f.description }}</div>
                  {% if f.id.value %}<input type="hidden" name="{{ f.id.html_name }}" value="{{ f.id.value }}">{% endif %}
                  {% if project_formset.can_delete %}
                    <button type="button" class="btn btn-sm btn-outline-danger remove-project">Remove Project</button>
                    <input type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.id_for_label }}" style="display:none;">
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-1">
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Education</span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-education">Add Education</button>
          </div>
          <div class="card-body">
            <div id="education-formset">
              {{ education_formset.management_form }}
              {% for f in education_formset %}
                <div class="border rounded p-3 mb-3 education-item">
                  <div class="mb-2"><label for="{{ f.school.id_for_label }}">School:</label> {{ f.school }}</div>
                  <div class="row">
                    <div class="col-md-6 mb-2"><label for="{{ f.graduation_month.id_for_label }}">Graduation Month:</label> {{ f.graduation_month }}</div>
                    <div class="col-md-6 mb-2"><label for="{{ f.graduation_year.id_for_label }}">Graduation Year:</label> {{ f.graduation_year }}</div>
                  </div>
                  <div class="mb-2"><label for="{{ f.major.id_for_label }}">Major:</label> {{ f.major }}</div>
                  <div class="mb-2"><label for="{{ f.degree.id_for_label }}">Degree:</label> {{ f.degree }}</div>
                  {% if f.id.value %}<input type="hidden" name="{{ f.id.html_name }}" value="{{ f.id.value }}">{% endif %}
                  {% if education_formset.can_delete %}
                    <button type="button" class="btn btn-sm btn-outline-danger remove-education">Remove Education</button>
                    <input type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.id_for_label }}" style="display:none;">
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Work Experience</span>
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-work">Add Work Experience</button>
          </div>
          <div class="card-body">
            <div id="work-formset">
              {{ work_formset.management_form }}
              {% for f in work_formset %}
                <div class="border rounded p-3 mb-3 work-item">
                  <div class="mb-2"><label for="{{ f.company.id_for_label }}">Company:</label> {{ f.company }}</div>
                  <div class="mb-2"><label for="{{ f.description.id_for_label }}">Description:</label> {{ f.description }}</div>
                  {% if f.id.value %}<input type="hidden" name="{{ f.id.html_name }}" value="{{ f.id.value }}">{% endif %}
                  {% if work_formset.can_delete %}
                    <button type="button" class="btn btn-sm btn-outline-danger remove-work">Remove Work Experience</button>
                    <input type="checkbox" name="{{ f.DELETE.html_name }}" id="{{ f.DELETE.id_for_label }}" style="display:none;">
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-end mt-4">
      <button type="submit" class="btn btn-primary">Save Profile</button>
    </div>
  </form>
</div>

<script>
  (function() {
    // Projects functionality
    const addProjectBtn = document.getElementById('add-project');
    const projectContainer = document.getElementById('projects-formset');
    if (addProjectBtn && projectContainer) {
      addProjectBtn.addEventListener('click', function() {
        const totalInput = projectContainer.querySelector('input[name$="-TOTAL_FORMS"]');
        const total = parseInt(totalInput.value, 10);
        const emptyTemplate = `
          <div class="border rounded p-3 mb-3 project-item">
            <div class="mb-2"><label for="id_projects-${total}-title">Title:</label> <input type="text" name="projects-${total}-title" class="form-control" id="id_projects-${total}-title"></div>
            <div class="mb-2"><label for="id_projects-${total}-url">Url:</label> <input type="url" name="projects-${total}-url" class="form-control" id="id_projects-${total}-url"></div>
            <div class="mb-2"><label for="id_projects-${total}-description">Description:</label> <textarea name="projects-${total}-description" class="form-control" id="id_projects-${total}-description"></textarea></div>
            <button type="button" class="btn btn-sm btn-outline-danger remove-project">Remove Project</button>
            <input type="hidden" name="projects-${total}-DELETE" id="id_projects-${total}-DELETE">
          </div>`;
        totalInput.value = total + 1;
        projectContainer.insertAdjacentHTML('beforeend', emptyTemplate);
      });
    }

    // Education functionality
    const addEducationBtn = document.getElementById('add-education');
    const educationContainer = document.getElementById('education-formset');
    if (addEducationBtn && educationContainer) {
      addEducationBtn.addEventListener('click', function() {
        const totalInput = educationContainer.querySelector('input[name$="-TOTAL_FORMS"]');
        const total = parseInt(totalInput.value, 10);
        const emptyTemplate = `
          <div class="border rounded p-3 mb-3 education-item">
            <div class="mb-2"><label for="id_education-${total}-school">School:</label> <input type="text" name="education-${total}-school" class="form-control" id="id_education-${total}-school"></div>
            <div class="row">
              <div class="col-md-6 mb-2"><label for="id_education-${total}-graduation_month">Graduation Month:</label> <select name="education-${total}-graduation_month" class="form-control" id="id_education-${total}-graduation_month">
                <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option>
                <option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option>
                <option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
              </select></div>
              <div class="col-md-6 mb-2"><label for="id_education-${total}-graduation_year">Graduation Year:</label> <input type="number" name="education-${total}-graduation_year" class="form-control" id="id_education-${total}-graduation_year"></div>
            </div>
            <div class="mb-2"><label for="id_education-${total}-major">Major:</label> <input type="text" name="education-${total}-major" class="form-control" id="id_education-${total}-major"></div>
            <div class="mb-2"><label for="id_education-${total}-degree">Degree:</label> <input type="text" name="education-${total}-degree" class="form-control" id="id_education-${total}-degree"></div>
            <button type="button" class="btn btn-sm btn-outline-danger remove-education">Remove Education</button>
            <input type="hidden" name="education-${total}-DELETE" id="id_education-${total}-DELETE">
          </div>`;
        totalInput.value = total + 1;
        educationContainer.insertAdjacentHTML('beforeend', emptyTemplate);
      });
    }

    // Work Experience functionality
    const addWorkBtn = document.getElementById('add-work');
    const workContainer = document.getElementById('work-formset');
    if (addWorkBtn && workContainer) {
      addWorkBtn.addEventListener('click', function() {
        const totalInput = workContainer.querySelector('input[name$="-TOTAL_FORMS"]');
        const total = parseInt(totalInput.value, 10);
        const emptyTemplate = `
          <div class="border rounded p-3 mb-3 work-item">
            <div class="mb-2"><label for="id_work-${total}-company">Company:</label> <input type="text" name="work-${total}-company" class="form-control" id="id_work-${total}-company"></div>
            <div class="mb-2"><label for="id_work-${total}-description">Description:</label> <textarea name="work-${total}-description" class="form-control" id="id_work-${total}-description"></textarea></div>
            <button type="button" class="btn btn-sm btn-outline-danger remove-work">Remove Work Experience</button>
            <input type="hidden" name="work-${total}-DELETE" id="id_work-${total}-DELETE">
          </div>`;
        totalInput.value = total + 1;
        workContainer.insertAdjacentHTML('beforeend', emptyTemplate);
      });
    }

    // Remove functionality for all formsets
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-project')) {
        const item = e.target.closest('.project-item');
        const deleteInput = item.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
          deleteInput.checked = true;
          deleteInput.value = 'on';
          item.style.display = 'none';
        } else {
          item.remove();
        }
      } else if (e.target.classList.contains('remove-education')) {
        const item = e.target.closest('.education-item');
        const deleteInput = item.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
          deleteInput.checked = true;
          deleteInput.value = 'on';
          item.style.display = 'none';
        } else {
          item.remove();
        }
      } else if (e.target.classList.contains('remove-work')) {
        const item = e.target.closest('.work-item');
        const deleteInput = item.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
          deleteInput.checked = true;
          deleteInput.value = 'on';
          item.style.display = 'none';
        } else {
          item.remove();
        }
      }
    });
  })();

  // Location Map Picker
  (function() {
    const mapDiv = document.getElementById('location-map');
    if (!mapDiv) return;

    let locationMap, locationMarker;
    const latInput = document.querySelector('#id_latitude');
    const lngInput = document.querySelector('#id_longitude');
    const statusSpan = document.getElementById('location-status');
    const clearBtn = document.getElementById('clear-location');
    
    // Log for debugging
    if (latInput && lngInput) {
      console.log('Latitude input value:', latInput.value);
      console.log('Longitude input value:', lngInput.value);
    }

    // Initialize map
    const initialLat = latInput && latInput.value ? parseFloat(latInput.value) : 39.8283;
    const initialLng = lngInput && lngInput.value ? parseFloat(lngInput.value) : -98.5795;
    const initialZoom = (latInput && latInput.value) ? 10 : 4;

    locationMap = L.map('location-map').setView([initialLat, initialLng], initialZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap'
    }).addTo(locationMap);

    // Function to create/update marker with popup
    function createOrUpdateMarker(lat, lng) {
      if (locationMarker) {
        locationMarker.setLatLng([lat, lng]);
      } else {
        // Create a custom icon for the location pin
        const locationIcon = L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
        
        locationMarker = L.marker([lat, lng], {
          draggable: true,
          icon: locationIcon
        }).addTo(locationMap);
        
        // Add drag handler
        locationMarker.on('dragend', function(e) {
          const pos = locationMarker.getLatLng();
          if (latInput) latInput.value = pos.lat.toFixed(6);
          if (lngInput) lngInput.value = pos.lng.toFixed(6);
          updateStatus(pos.lat, pos.lng);
          updateMarkerPopup(pos.lat, pos.lng);
        });
      }
      updateMarkerPopup(lat, lng);
    }
    
    // Function to update marker popup
    function updateMarkerPopup(lat, lng) {
      if (locationMarker) {
        locationMarker.bindPopup(`
          <div style="text-align: center;">
            <strong>Your Location</strong><br>
            Latitude: ${lat.toFixed(6)}<br>
            Longitude: ${lng.toFixed(6)}
          </div>
        `).openPopup();
      }
    }

    // Add existing marker if coordinates exist (saved location)
    if (latInput && latInput.value && lngInput && lngInput.value) {
      const lat = parseFloat(latInput.value);
      const lng = parseFloat(lngInput.value);
      createOrUpdateMarker(lat, lng);
      locationMap.setView([lat, lng], 12); // Zoom in closer to show the saved location
      updateStatus(lat, lng);
      // Show popup after a short delay to ensure map is fully loaded
      setTimeout(() => {
        if (locationMarker) {
          locationMarker.openPopup();
        }
      }, 500);
    } else {
      // No saved location
      if (statusSpan) {
        statusSpan.textContent = 'No location set. Click on the map to set your location.';
        statusSpan.style.color = '#6c757d';
      }
    }

    // Handle map click
    locationMap.on('click', function(e) {
      const lat = e.latlng.lat;
      const lng = e.latlng.lng;

      if (latInput) latInput.value = lat.toFixed(6);
      if (lngInput) lngInput.value = lng.toFixed(6);

      createOrUpdateMarker(lat, lng);
      updateStatus(lat, lng);
    });

    // Clear location button
    if (clearBtn) {
      clearBtn.addEventListener('click', function() {
        if (locationMarker) {
          locationMap.removeLayer(locationMarker);
          locationMarker = null;
        }
        if (latInput) latInput.value = '';
        if (lngInput) lngInput.value = '';
        if (statusSpan) statusSpan.textContent = 'No location set';
        locationMap.setView([39.8283, -98.5795], 4);
      });
    }

    function updateStatus(lat, lng) {
      if (statusSpan) {
        statusSpan.innerHTML = `<strong>Saved Location:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)} <i class="fas fa-map-marker-alt text-primary"></i>`;
        statusSpan.style.color = '#28a745';
      }
    }

    // Try to get user's current location
    if (navigator.geolocation && !latInput.value) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          locationMap.setView([lat, lng], 10);
        },
        function() {
          // User denied or error getting location, keep default view
        }
      );
    }
  })();
</script>
{% endblock %}
