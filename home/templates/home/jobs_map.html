<script>
document.addEventListener('DOMContentLoaded', function () {
  const map = L.map('map').setView([33.7756, -84.3963], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  const list = document.getElementById('jobList');
  const radiusInput = document.getElementById('radius');
  const reloadBtn = document.getElementById('reload');

  let jobMarkers = [];
  function setLoading(on) { list.innerHTML = on ? '<li class="list-group-item">Loading...</li>' : ''; }
  function clearMarkers() { jobMarkers.forEach(m => map.removeLayer(m)); jobMarkers = []; }
  function getRadius() { return parseInt(radiusInput.value, 10) || 25; }

  async function loadJobs(lat, lng, radiusKm) {
    setLoading(true);
    try {
      const url = `/api/jobs/?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&radius_km=${encodeURIComponent(radiusKm)}`;
      console.log('Fetching jobs:', url);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      renderJobs(data.jobs || []);
    } catch (err) {
      console.error('Failed to load jobs:', err);
      list.innerHTML = `<li class="list-group-item text-danger">Error loading jobs: ${String(err)}</li>`;
    } finally {
      // ensure we donâ€™t stay on "Loading..."
      if (!list.innerHTML.includes('Error') && list.innerHTML.includes('Loading')) list.innerHTML = '';
    }
  }

  function renderJobs(jobs) {
    clearMarkers();
    list.innerHTML = '';
    if (!jobs.length) {
      list.innerHTML = '<li class="list-group-item">No jobs found.</li>';
      return;
    }
    jobs.forEach(j => {
      if (j.lat == null || j.lng == null) return;
      const m = L.marker([j.lat, j.lng]).addTo(map);
      m.bindPopup(`<strong>${j.title ?? ''}</strong><br>${j.company ?? ''}<br>${[j.city, j.state].filter(Boolean).join(', ')}`);
      jobMarkers.push(m);

      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `<div class="fw-semibold">${j.title ?? ''}</div>
                      <div>${j.company ?? ''}</div>
                      <div class="text-muted">${[j.city, j.state].filter(Boolean).join(', ')}</div>`;
      li.onclick = () => { map.setView([j.lat, j.lng], 14); m.openPopup(); };
      list.appendChild(li);
    });
  }

  function initFromGeolocation() {
    setLoading(true);
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => loadJobs(pos.coords.latitude, pos.coords.longitude, getRadius()),
        ()  => loadJobs(33.7756, -84.3963, getRadius())
      );
    } else {
      loadJobs(33.7756, -84.3963, getRadius());
    }
  }

  radiusInput.addEventListener('input', e => {
    const label = document.getElementById('radiusLabel'); if (label) label.textContent = e.target.value;
  });
  reloadBtn.addEventListener('click', initFromGeolocation);
  initFromGeolocation();
});
</script>
