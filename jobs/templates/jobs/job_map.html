{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container my-4">
  <h1 class="mb-3">Jobs Near Me</h1>
  <div id="map" style="height: 520px; border-radius: 12px;"></div>
  <p class="text-muted mt-2">Showing {{ jobs|length }} job(s) with coordinates.</p>
</div>

<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function () {
  console.log("[jobs/map] script starting");

  const map = L.map('map').setView([33.7490, -84.3880], 12); // ATL default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // Endpoints
  const radiusApi = "/api/jobs/";                  // home.views.jobs_geojson
  const allJobsApi = "{% url 'jobs.geo' %}";       // jobs.views.jobs_geo_api

  console.log("[jobs/map] endpoints", { radiusApi, allJobsApi });

  // A layer group to hold markers we add
  const jobsLayer = L.layerGroup().addTo(map);
  let hereMarker;

  function markHere(lat, lng) {
    if (hereMarker) map.removeLayer(hereMarker);
    hereMarker = L.marker([lat, lng]).addTo(map).bindPopup('You are here').openPopup();
  }

  function addFeatures(geo) {
    const pts = [];
    (geo.features || []).forEach(f => {
      if (!f || !f.geometry || !f.geometry.coordinates) return;
      const [lngJ, latJ] = f.geometry.coordinates;      // GeoJSON = [lng, lat]
      const p = f.properties || {};
      const m = L.marker([latJ, lngJ])
        .bindPopup(`<b>${p.title || ''}</b><br>${p.company || ''}<br>${p.location || ''}<br><a href="${p.detail_url || '#'}">View</a>`);
      jobsLayer.addLayer(m);
      pts.push([latJ, lngJ]);
    });
    if (pts.length) {
      map.fitBounds(L.latLngBounds(pts), { padding: [20, 20] });
    }
    console.log("[jobs/map] rendered markers:", pts.length);
  }

  // Helper to fetch JSON with clear logging
  function fetchJSON(url) {
    console.log("[jobs/map] fetching:", url);
    return fetch(url, { credentials: 'same-origin' })
      .then(r => {
        console.log("[jobs/map] response", url, r.status);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      });
  }

  // --- TEST 1: load ALL jobs (no radius) to prove markers render ---
  fetchJSON(allJobsApi)
    .then(geo => {
      console.log("[jobs/map] jobs.geo payload:", geo);
      addFeatures(geo);
    })
    .catch(err => console.error("[jobs/map] jobs.geo error:", err));

  // --- TEST 2: also load NEARBY jobs (radius) using map center ---
  function loadNearby() {
    const c = map.getCenter();
    const radiusKm = 50; // adjust if you want
    const url = `${radiusApi}?lat=${c.lat}&lng=${c.lng}&radius_km=${radiusKm}`;
    fetchJSON(url)
      .then(geo => {
        console.log("[jobs/map] /api/jobs payload:", geo);
        // (optional) clear old and render only radius results:
        // jobsLayer.clearLayers();
        // addFeatures(geo);
      })
      .catch(err => console.error("[jobs/map] /api/jobs error:", err));
  }

  // Geolocate (optional), then mark and try nearby load
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat, lng], 13);
        markHere(lat, lng);
        loadNearby();
      },
      () => {
        const [lat, lng] = [33.7490, -84.3880];
        map.setView([lat, lng], 12);
        markHere(lat, lng);
        loadNearby();
      },
      { enableHighAccuracy: true, timeout: 8000 }
    );
  } else {
    const [lat, lng] = [33.7490, -84.3880];
    map.setView([lat, lng], 12);
    markHere(lat, lng);
    loadNearby();
  }
})();
</script>


{% endblock %}
